<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Machine Dashboard with YAML Export</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function getMachines() {
      return JSON.parse(localStorage.getItem("machines") || "[]");
    }

    function saveMachines(machines) {
      localStorage.setItem("machines", JSON.stringify(machines));
    }

    function addMachine() {
      const datacenter = document.getElementById("datacenter").value;
      const name = document.getElementById("name").value;
      const ip = document.getElementById("ip").value;
      const port = parseInt(document.getElementById("port").value);
      const environment = document.getElementById("environment").value;
      const editIndex = document.getElementById("editIndex").value;

      if (!datacenter || !name || !ip || !port || !environment) {
        alert("‚ö† Please fill in all fields");
        return;
      }

      let machines = getMachines();

      if (editIndex !== "") {
        machines[editIndex] = { datacenter, name, ip, port, environment };
        alert("‚úÖ Machine updated successfully!");
      } else {
        machines.push({ datacenter, name, ip, port, environment });
        alert("‚úÖ Machine added successfully!");
      }

      saveMachines(machines);
      resetForm();
      loadMachines();
    }

    function loadMachines() {
      let machines = getMachines();

      const filterName = document.getElementById("filter_name").value.toLowerCase();
      const filterIP = document.getElementById("filter_ip").value.toLowerCase();
      const filterPort = document.getElementById("filter_port").value;
      const filterEnv = document.getElementById("filter_environment").value;

      if (filterName) machines = machines.filter(m => m.name.toLowerCase().includes(filterName));
      if (filterIP) machines = machines.filter(m => m.ip.toLowerCase().includes(filterIP));
      if (filterPort) machines = machines.filter(m => m.port == filterPort);
      if (filterEnv) machines = machines.filter(m => m.environment === filterEnv);

      const table = document.getElementById("machineTable");
      table.innerHTML = "";
      machines.forEach((m, index) => {
        table.innerHTML += `
          <tr class="border-b hover:bg-gray-100">
            <td class="p-2"><input type="checkbox" class="machine-select" data-index="${index}"></td>
            <td class="p-2">${m.datacenter}</td>
            <td class="p-2">${m.name}</td>
            <td class="p-2">${m.ip}</td>
            <td class="p-2">${m.port}</td>
            <td class="p-2">${m.environment}</td>
            <td class="p-2 flex gap-2">
              <button onclick="editMachine(${index})" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Edit</button>
              <button onclick="deleteMachine(${index})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
            </td>
          </tr>`;
      });
    }

    function deleteMachine(index) {
      if (confirm("‚ùå Are you sure you want to delete this machine?")) {
        let machines = getMachines();
        machines.splice(index, 1);
        saveMachines(machines);
        loadMachines();
      }
    }

    function editMachine(index) {
      const m = getMachines()[index];
      document.getElementById("datacenter").value = m.datacenter;
      document.getElementById("name").value = m.name;
      document.getElementById("ip").value = m.ip;
      document.getElementById("port").value = m.port;
      document.getElementById("environment").value = m.environment;
      document.getElementById("editIndex").value = index;
    }

    function resetForm() {
      document.querySelectorAll("#datacenter, #name, #ip, #port, #environment").forEach(el => el.value = "");
      document.getElementById("editIndex").value = "";
    }

    function toggleSelectAll(source) {
      document.querySelectorAll(".machine-select").forEach(cb => cb.checked = source.checked);
    }

    function exportSelectedToYAML() {
      const checkboxes = document.querySelectorAll(".machine-select:checked");
      const machines = getMachines();
      let yamlOutput = "";

      checkboxes.forEach(cb => {
        const m = machines[cb.dataset.index];
        yamlOutput += `Host ${m.name}\n     HostName ${m.ip}\n     User root\n\n`;
      });

      document.getElementById("yamlOutput").value = yamlOutput.trim();
    }

    function copyYAMLToClipboard() {
      const yamlText = document.getElementById("yamlOutput").value;
      if (!yamlText) {
        alert("‚ö† No YAML output to copy!");
        return;
      }
      navigator.clipboard.writeText(yamlText).then(() => {
        alert("üìã YAML copied to clipboard!");
      });
    }

    function downloadYAMLFile() {
      const yamlText = document.getElementById("yamlOutput").value;
      if (!yamlText) {
        alert("‚ö† No YAML output to download!");
        return;
      }
      const blob = new Blob([yamlText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ssh_config";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen p-6" onload="loadMachines()">

  <div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold text-gray-700 mb-4">üíª Machine Dashboard with YAML Export</h1>

    <input type="hidden" id="editIndex">

    <!-- Add Machine Form -->
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
      <input id="datacenter" placeholder="Datacenter" class="border p-2 rounded col-span-1 md:col-span-2">
      <input id="name" placeholder="Machine Name" class="border p-2 rounded col-span-1 md:col-span-2">
      <input id="ip" placeholder="IP Address" class="border p-2 rounded col-span-1">
      <input id="port" placeholder="Port" type="number" class="border p-2 rounded col-span-1">
      <select id="environment" class="border p-2 rounded col-span-1">
        <option value="">Environment</option>
        <option value="staging">Staging</option>
        <option value="production">Production</option>
      </select>
      <button onclick="addMachine()" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 col-span-1">Save</button>
    </div>

    <!-- Filters -->
    <h2 class="text-lg font-semibold text-gray-600 mb-2">üîç Filter Machines</h2>
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
      <input id="filter_name" placeholder="Machine Name" class="border p-2 rounded col-span-1 md:col-span-2">
      <input id="filter_ip" placeholder="IP Address" class="border p-2 rounded col-span-1 md:col-span-2">
      <input id="filter_port" placeholder="Port" type="number" class="border p-2 rounded col-span-1">
      <select id="filter_environment" class="border p-2 rounded col-span-1">
        <option value="">Any</option>
        <option value="staging">Staging</option>
        <option value="production">Production</option>
      </select>
      <button onclick="loadMachines()" class="bg-green-500 text-white p-2 rounded hover:bg-green-600 col-span-1">Filter</button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto mb-4">
      <table class="min-w-full border border-gray-200 rounded">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-2"><input type="checkbox" onclick="toggleSelectAll(this)"></th>
            <th class="p-2 text-left">Datacenter</th>
            <th class="p-2 text-left">Name</th>
            <th class="p-2 text-left">IP</th>
            <th class="p-2 text-left">Port</th>
            <th class="p-2 text-left">Environment</th>
            <th class="p-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="machineTable" class="bg-white"></tbody>
      </table>
    </div>

    <!-- Export Buttons -->
    <div class="flex gap-2 mb-2">
      <button onclick="exportSelectedToYAML()" class="bg-purple-500 text-white p-2 rounded hover:bg-purple-600">Export Selected to YAML</button>
      <button onclick="copyYAMLToClipboard()" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Copy YAML</button>
      <button onclick="downloadYAMLFile()" class="bg-green-500 text-white p-2 rounded hover:bg-green-600">Download Config</button>
    </div>

    <!-- Output Area -->
    <textarea id="yamlOutput" rows="8" class="w-full border p-2 rounded" readonly></textarea>
  </div>

</body>
</html>
